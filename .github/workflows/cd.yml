name: ğŸš€ CD - Deploy to Production

# ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥ (ìŠ¹ì¸ í•„ìš”)
on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ë°°í¬í•  ì´ë¯¸ì§€ íƒœê·¸ (ì˜ˆ: abc123 ë˜ëŠ” latest)'
        required: true
        default: 'latest'
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        type: choice
        options:
          - production
          - staging

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: https://cabinet.42gy.kr
    
    steps:
      ##########################################################################
      # Step 1: ë°°í¬ ìŠ¹ì¸ í™•ì¸
      ##########################################################################
      - name: ğŸ” Deployment Info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ ë°°í¬ ì •ë³´"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "í™˜ê²½: ${{ github.event.inputs.environment }}"
          echo "ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "ì‹¤í–‰ì: ${{ github.actor }}"
          echo "ì‹œê°„: $(date)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      ##########################################################################
      # Step 2: SSHë¡œ ì„œë²„ ì ‘ì† ë° ë°°í¬
      ##########################################################################
      - name: ğŸš€ Deploy to Server (Blue-Green)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ${{ secrets.DEPLOY_PATH || '/home/user/42_Cabinet/ft_cabinet_BE' }}
            
            # ìµœì‹  ì½”ë“œ pull
            git pull origin main
            
            # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
            export $(cat .env | xargs)
            
            # ìµœì‹  ì´ë¯¸ì§€ pull
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}
            
            # Blue-Green ë°°í¬ ì‹¤í–‰
            ./scripts/deploy.sh ${{ github.event.inputs.image_tag }}

      ##########################################################################
      # Step 3: ë°°í¬ ì™„ë£Œ
      ##########################################################################
      - name: âœ… Deployment Complete
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ë°°í¬ ì„±ê³µ!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "í™˜ê²½: ${{ github.event.inputs.environment }}"
          echo "ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      ##########################################################################
      # Step 4: ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      ##########################################################################
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "í™˜ê²½: ${{ github.event.inputs.environment }}"
          echo "ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

