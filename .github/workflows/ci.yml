name: ğŸ”¨ CI - Build & Test

# PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì‹¤í–‰
on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      ##########################################################################
      # Step 1: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      ##########################################################################
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      ##########################################################################
      # Step 2: Java 17 ì„¤ì •
      ##########################################################################
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: 'gradle'

      ##########################################################################
      # Step 3: Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í¬í•¨)
      ##########################################################################
      - name: ğŸ”¨ Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build

      ##########################################################################
      # Step 4: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¦¬í¬íŠ¸
      ##########################################################################
      - name: ğŸ“Š Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: build/test-results/**/*.xml
          reporter: java-junit

      ##########################################################################
      # Step 5: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      ##########################################################################
      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t ghcr.io/${{ github.repository }}:${{ github.sha }} .
          docker tag ghcr.io/${{ github.repository }}:${{ github.sha }} ghcr.io/${{ github.repository }}:latest

      ##########################################################################
      # Step 6: GitHub Container Registry ë¡œê·¸ì¸
      ##########################################################################
      - name: ğŸ”‘ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      ##########################################################################
      # Step 7: Docker ì´ë¯¸ì§€ í‘¸ì‹œ
      ##########################################################################
      - name: ğŸ“¤ Push Docker Image
        run: |
          docker push ghcr.io/${{ github.repository }}:${{ github.sha }}
          docker push ghcr.io/${{ github.repository }}:latest

      ##########################################################################
      # Step 8: ì„±ê³µ ë©”ì‹œì§€
      ##########################################################################
      - name: âœ… CI Success
        if: success()
        run: |
          echo "âœ… CI ì„±ê³µ!"
          echo "Image: ghcr.io/${{ github.repository }}:${{ github.sha }}"
          echo "ë°°í¬ëŠ” CD ì›Œí¬í”Œë¡œìš°ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”."

